apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-go-binaries
spec:
  params:
    - default: operate-first
      description: the git organization title.
      name: git_organization
      type: string
    - default: opfcli
      description: The git repository title.
      name: git_repository
      type: string
    - default: linux-arm|linux-arm64|linux-amd64|darwin-amd64
      description: >-
        OS strategy with which binaries are built. Inputed as string delineated
        with pipes, such as "Darwin-amd64|linux-amd64|" etc.
      name: build_strategy_OS_x_ARCH
      type: string
    - description: Github token for bot access to the repository.
      name: GITHUB_TOKEN
      type: string
    - description: The existing or desired tag name.
      name: git_tag
      type: string
  resources:
    inputs:
      - name: repo
        type: git
  steps:
    - env:
        - name: binary-strategies
          value: $(params.build_strategy_OS_x_ARCH)
      image: 'quay.io/thoth-station/s2i-thoth-ubi8-py36:latest'
      name: binary-builds
      resources: {}
      script: |
        IFS="|" read -ra strategies_array <<< $binary-strategies
        mkdkir binaries
        for build in "${strategies_array[@]}"; do 
          GOARCH="$(echo $build | cut -d '-' -f2)"
          GOOS="${build}%%-*"
          make
        done
      securityContext:
        privileged: true
      workingDir: /workspace/repo
    - image: 'quay.io/thoth-station/s2i-thoth-ubi8-py36:latest'
      name: push-artifacts
      resources: {}
      script: >
        #!/usr/libexec/platform-python

        import requests
        import os 
        import json

        binaries_base_path="/workspace/repo/binaries";
        binaries=os.listdir("/workspace/repo/binaries");
        release=requests.get('https://api.github.com/repos/$(params.git_organization)/$(params.git_repository)/releases/tags/$(params.git_tag)').json();
        release_url  = release.url 
        release_id_index  =  release_info.index("releases/") + 9;
        release_id = release_url[(len(release_url)-release_id_index):];
        upload_url = release.upload_url 
        values={}

        for binary in binaries:
          values['name'] = binary
          #values['asset_id']=counter
          files={'upload_file': open(f'{binaries_base_path}/{binary}', 'rb'), 'name': f'{binary}'}
          content_length = os.path.getsize(f'{binaries_base_path}/{binary}')
          headers = {'Content-Type': 'multipart/form-data', 'Content-Length': f'{content_length}'}
          requests.post("https://uploads.github.com/repos/$(params.git_organization)/$(params.git_repository)/releases/{release_id}/assets/" , files=files, values=values);
          #counter++;
          print(response.json());
      securityContext:
        privileged: true
      workingDir: /workspace/repo